---
title: "online T1 analysis"
output: pdf_document
date: "2025-04-14"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r load libraries}
library(dplyr)
library(car)
library(lme4)
library(lmerTest)
library(Matrix)
library(tidyr)
library(readxl)
library(ggpubr)
library(interactions)
library(performance) #checking model performance
library(margins)
library(tibble) #plot
library(ggplot2) #plot

#rm(list = ls())
```
# Functions
```{r functions}
# Z-score
normalize = function(x) {
  return ((x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE))
}

# Function to recode variables
var_recode = function(data){
  data$age_z <- normalize(data$age)
  data$edu_z <- normalize(data$edu_level)
  data$income_z <- normalize(data$income_order)
  data$ses <- data$edu_z + data$income_z
  data$poc <- ifelse(data$race == "White", 0, 1) # POC coded as 1
  data$poc <- factor(data$poc)
  data$female <- ifelse(data$sex == 2, 1, 0)  # Female=1, Male+Other=0
  #data$female <- ifelse(data$sex == 2, 1, 
                      #ifelse(data$sex == 3, NA, 0)) # Female coded as 1, Other as NA, Male as 0, row 150
  data$female = factor(data$female)
  data$group = factor(data$group, levels = c("Healthy", "Depression", "Anhedonia", "Both"))
  
  # mean centering for main effect
  data$depression_mc = data$depression - mean(data$depression)
  data$anhedonia_mc = data$anhedonia - mean(data$anhedonia)
  
  # raw score
  data$pvss_reversed <- -data$pvss_total
  data$bdi_total_z <- scale(data$bdi_total)
  data$pvss_total_z <- scale(data$pvss_reversed) 
  
  return(data)
}

# Function to extract coefficients from a model
extract_coefs <- function(model, model_name) {
  coefs <- summary(model)$coefficients
  as.data.frame(coefs) %>%
    rownames_to_column("term") %>%
    filter(term %in% c("depression_mc", "anhedonia_mc", "depression_mc:anhedonia_mc")) %>%
    mutate(
      conf.low = Estimate - `Std. Error`,
      conf.high = Estimate + `Std. Error`,
      term_clean = case_when(
        term == "depression_mc" ~ "depression",
        term == "anhedonia_mc" ~ "anhedonia",
        term == "depression_mc:anhedonia_mc" ~ "interaction"
      ),
      model = model_name,
      sig_label = case_when(
        `Pr(>|t|)` < 0.001 ~ "***",
        `Pr(>|t|)` < 0.01  ~ "**",
        `Pr(>|t|)` < 0.05  ~ "*",
        TRUE ~ ""
      )
    ) %>%
    select(model, term_clean, Estimate, `Std. Error`, conf.low, conf.high, sig_label)
}

# save stats results 
save_model_to_excel <- function(model, filename, include_random = TRUE) {
  library(openxlsx)
  
  # Extract fixed effects
  summary_df <- data.frame(
    Variable = rownames(summary(model)$coefficients),
    summary(model)$coefficients,
    row.names = NULL
  )
  
  # Start with list containing fixed effects
  output_list <- list(Fixed = summary_df)
  
  # Optionally add random effects
  if (include_random) {
    random_df <- as.data.frame(VarCorr(model))
    output_list$Random <- random_df
  }
  
  # Save to Excel
  write.xlsx(output_list, file = filename, rowNames = FALSE)
}

```
# Data load & recode
```{r Data load}
ug_data = read.csv("../data/LEAP_baseline_ug_n236_analysis.csv")
ug_model= read.csv("../ug_modeling/baseline_fit/UG_fit_RWvarf0_May25.csv") 

rl_data = read.csv("../data/LEAP_baseline_rl_n220_analysis.csv")
rl_model= read.csv("../rl_modeling/baseline_fit/RL_fit_RW_valence_T1_May25.csv")
```

```{r Variable recode}
ug_data = var_recode(ug_data)

rl_data = var_recode(rl_data)
rl_data$block_type_recode = factor(rl_data$block_type, levels= c("numberbar_mixed","numberbar_pos","numberbar_neg"),labels=c("Mixed","Positive","Negative"))

print('UG RT')
summary(ug_data$choice_rt)

print('Slot RT')
summary(rl_data$rt)
```
# UG model-agnostic regression
```{r UG: RT LMM}
ug.rt = lmer(data = ug_data, 
            formula = log_rt ~  depression_mc + anhedonia_mc + depression_mc*anhedonia_mc + factor(choice_acc)*offer
            + ladder_us + md_anx_prior_diag + female + age
            + (1 + offer | participant),
            control = lmerControl(optimizer = 'bobyqa', optCtrl = list(maxfun = 1e7)))
```

```{r UG: RT result}
summary(ug.rt)
model_performance(ug.rt)
```

```{r UG: RR LMM}
ug.rr = glmer(data = ug_data, 
                formula = choice_acc ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc
                + offer + offer*depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age
                + (1 + offer | participant), # separate assume no correlation between intercept and slope
                family = binomial(link = "logit"), glmerControl(optimizer='bobyqa', optCtrl=list(maxfun=1e6)))
```

```{r UG: RR result}
summary(ug.rr) 
model_performance(ug.rr)
```

```{r UG: MR LMM}
ug.md = lmer(data = ug_data, 
                formula = rating ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc + factor(choice_acc)*offer
                + ladder_us + md_anx_prior_diag + female + age
                + (1 + offer + factor(choice_acc) | participant),
                control = lmerControl(optimizer = "bobyqa", optCtrl = list(method = "L-BFGS-B", maxfun = 1e9)))
```

```{r UG: MR result}
summary(ug.md)
performance(ug.md)
```

# UG model-based analysis
```{r UG: recode}
# mean centering for main effect
ug_model$depression_mc = ug_model$depression - mean(ug_model$depression)
ug_model$anhedonia_mc = ug_model$anhedonia - mean(ug_model$anhedonia)
```

```{r UG: norm aversion}
ug.envy <- lm(data = ug_model, 
                formula = envy ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc)
summary(ug.envy)
confint(ug.envy)
performance(ug.envy)
```
```{r UG: learning rate}
ug.lr <- lm(data = ug_model, 
                formula = lr ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc)
summary(ug.lr)
confint(ug.lr)
performance(ug.lr)
```
```{r UG: initial norm}
ug.f0 <- lm(data = ug_model, 
                formula = f0 ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc)
summary(ug.f0)
confint(ug.f0)
performance(ug.f0)
```

```{r UG: stats format}
coef_all <- bind_rows(
  extract_coefs(ug.f0, "f0"),
  extract_coefs(ug.envy, "envy"),
  extract_coefs(ug.lr, "alpha")
)

# Factor ordering
coef_all <- coef_all %>%
  mutate(
    term_clean = factor(term_clean, levels = c("depression", "anhedonia", "interaction")),
    model = factor(model, levels = c("f0", "envy", "alpha"))
  )

# Compute fixed star heights per model
y_star_pos <- coef_all %>%
  group_by(model) %>%
  summarise(y = max(conf.high) + 0.1)

coef_all <- left_join(coef_all, y_star_pos, by = "model")
```

```{r UG: plot setting}
# Custom fill colors (Pride flagâ€“inspired)
fill_colors <- c(
  "depression" = "#abb9f5",  
  "interaction" = "#5D77EC",
  "anhedonia" = "#193CD6"
)

# Custom facet labels
facet_labels <- c(
  f0 = "initial norm",
  envy = "norm aversion",
  alpha = "norm update"
)

# Ensure custom bar order
coef_all <- coef_all %>%
  mutate(
    term_clean = factor(term_clean, levels = c("depression", "interaction", "anhedonia")),
    model = factor(model, levels = c("f0", "envy", "alpha"))
  )
```

```{r UG: model figure 4 g-i}
ggplot(coef_all, aes(x = term_clean, y = Estimate, fill = term_clean)) +
  geom_bar(stat = "identity", width = 0.55) +  # skinnier bars, less space
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  geom_text(aes(y = y, label = sig_label), size = 10, color = "black") +  # bigger stars
  facet_wrap(~model, labeller = as_labeller(facet_labels), nrow = 1) +    # force 1 row
  labs(x = NULL, y = "coefficient (UG baseline)", fill = NULL) +
  scale_fill_manual(values = fill_colors) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 18) +  # increase base font size
  theme(
    panel.grid       = element_blank(),
    axis.text.x      = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text.y      = element_text(size = 16),
    axis.title.y     = element_text(size = 18, margin = margin(r = 10)),
    strip.text       = element_text(size = 18, face = "plain"),
    legend.position  = "bottom",
    legend.direction = "horizontal",
    legend.justification = "center",
    legend.box       = "horizontal",
    legend.text      = element_text(size = 16),
    plot.margin      = margin(10, 10, 10, 10),  # tighter margins
    strip.placement  = "outside",              # put facet labels outside panels
    panel.spacing    = unit(0.8, "lines")      # reduce spacing between panels
  )

```
```{r UG: figure save}
ggsave(
  filename = "./figure/ug_param_effect_T1_varf0.jpg",
  plot = last_plot(),      # or specify your plot object name if assigned
  width = 14,               # adjust as needed
  height = 6,              # adjust as needed
  dpi = 300,
  units = "in"
)
```

# RL model-agnostic regression
```{r RL: by block data}
# LME per block
rl.neg_df = subset(rl_data, block_type_recode == 'Negative')
rl.mix_df = subset(rl_data, block_type_recode == 'Mixed')
rl.pos_df = subset(rl_data, block_type_recode == 'Positive')
```

```{r RL: RT LMM}
rl.rt.neg = lmer(data = rl.neg_df, 
                formula = log_rt ~  depression_mc + anhedonia_mc + optimal
                + depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age
                + (1 | participant),
                control = lmerControl(optCtrl = list(maxfun = 1e6)))
rl.rt.mix = lmer(data = rl.mix_df, 
                formula = log_rt ~  depression_mc + anhedonia_mc + optimal
                + depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age
                + (1 | participant),
                control = lmerControl(optCtrl = list(maxfun = 1e6)))
rl.rt.pos = lmer(data = rl.pos_df, 
                formula = log_rt ~  depression_mc + anhedonia_mc + optimal
                + depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age
                + (1 | participant),
                control = lmerControl(optCtrl = list(maxfun = 1e6)))
```

```{r RL: RT result}
summary(rl.rt.neg)
summary(rl.rt.mix)
summary(rl.rt.pos)
```

```{r RL: OC LMM}
rl.opt.neg = glmer(data = rl.neg_df, 
                formula = optimal ~  depression_mc + anhedonia_mc + depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age_z
                + (1 | participant),
                family = binomial(link="logit"),
                control = glmerControl(optimizer='bobyqa', optCtrl=list(maxfun=1e7)))
rl.opt.mix = glmer(data = rl.mix_df, 
                formula = optimal ~  depression_mc + anhedonia_mc + depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age_z
                + (1 | participant),
                family = binomial(link="logit"),
                control = glmerControl(optimizer='bobyqa', optCtrl=list(maxfun=1e7)))
rl.opt.pos = glmer(data = rl.pos_df, 
                formula = optimal ~  depression_mc + anhedonia_mc + depression_mc*anhedonia_mc
                + ladder_us + md_anx_prior_diag + female + age_z
                + (1 | participant),
                family = binomial(link="logit"),
                control = glmerControl(optimizer='bobyqa', optCtrl=list(maxfun=1e7)))
```

```{r RL: OC result}
summary(rl.opt.neg)
summary(rl.opt.mix)
summary(rl.opt.pos)
```

# RL model-based analysis
```{r RL: recode}
# mean centering for main effect
rl_model$depression_mc = rl_model$depression - mean(rl_model$depression)
rl_model$anhedonia_mc = rl_model$anhedonia - mean(rl_model$anhedonia)
```

```{r RL: positive block alpha}
rl.alphapos <- lm(data = rl_model, 
                formula = alpha_pos ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc)
summary(rl.alphapos)
confint(rl.alphapos)
performance(rl.alphapos)
```

```{r RL: negative block alpha}
rl.alphaneg <- lm(data = rl_model, 
                formula = alpha_neg ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc)
summary(rl.alphaneg)
confint(rl.alphaneg)
performance(rl.alphaneg)
```
```{r RL: inverse temerapture}
rl.beta <- lm(data = rl_model, 
                formula = beta ~ depression_mc + anhedonia_mc + depression_mc*anhedonia_mc)
summary(rl.beta)
confint(rl.beta)
performance(rl.beta)
```


```{r RL: stats format}
coef_all <- bind_rows(
  extract_coefs(rl.alphaneg, "negative alpha"),
  extract_coefs(rl.alphapos, "positive alpha"),
  extract_coefs(rl.beta, "inverse temperature")
)

# Factor ordering
coef_all <- coef_all %>%
  mutate(
    term_clean = factor(term_clean, levels = c("depression", "anhedonia", "interaction")),
    model = factor(model, levels = c("negative alpha", "positive alpha", "inverse temperature"))
  )

# Compute fixed star heights per model
y_star_pos <- coef_all %>%
  group_by(model) %>%
  summarise(y = max(conf.high) + 0.1)

coef_all <- left_join(coef_all, y_star_pos, by = "model")
```
```{r RL: plot setting}
# Custom fill colors (Pride flagâ€“inspired)
fill_colors <- c(
  "depression" = "#f5abb9",                   # Light blue
  "interaction" = "#EC5D77",                  # Soft purple
  "anhedonia" = "#D6193C"                     # Light pink
)

# Ensure custom bar order
coef_all <- coef_all %>%
  mutate(
    term_clean = factor(term_clean, levels = c("depression", "interaction", "anhedonia")),
    model = factor(model, levels = c("negative alpha", "positive alpha", "inverse temperature"))
  )
```

```{r UG: model figure 4 g-i}
ggplot(coef_all, aes(x = term_clean, y = Estimate, fill = term_clean)) +
  geom_bar(stat = "identity", width = 0.55) +  # skinnier bars, less space
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  geom_text(aes(y = y, label = sig_label), size = 10, color = "black") +  # bigger stars
  facet_wrap(~model, nrow = 1) +    # force 1 row
  labs(x = NULL, y = "coefficient (RL baseline)", fill = NULL) +
  scale_fill_manual(values = fill_colors) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_size = 18) +  # increase base font size
  theme(
    panel.grid       = element_blank(),
    axis.text.x      = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text.y      = element_text(size = 16),
    axis.title.y     = element_text(size = 18, margin = margin(r = 10)),
    strip.text       = element_text(size = 18, face = "plain"),
    legend.position  = "bottom",
    legend.direction = "horizontal",
    legend.justification = "left",
    legend.box       = "horizontal",
    legend.text      = element_text(size = 16),
    plot.margin      = margin(10, 10, 10, 10),  # tighter margins
    strip.placement  = "outside",              # put facet labels outside panels
    panel.spacing    = unit(0.8, "lines")      # reduce spacing between panels
  )

```
```{r RL: figure save}
ggsave(
  filename = "./figure/rl_param_effect_T1.jpg",
  plot = last_plot(),      # or specify your plot object name if assigned
  width = 14,               # adjust as needed
  height = 6,              # adjust as needed
  dpi = 300,
  units = "in"
)

```

# Results saving
```{r UG SI}
save_model_to_excel(ug.rt, "../lme_results/ug_T1/ug_rt.xlsx", include_random = TRUE)
save_model_to_excel(ug.rr, "../lme_results/ug_T1/ug_rr.xlsx", include_random = TRUE)
save_model_to_excel(ug.md, "../lme_results/ug_T1/ug_md.xlsx", include_random = TRUE)

save_model_to_excel(ug.envy, "../lme_results/ug_T1/ug_envy.xlsx", include_random = FALSE)
save_model_to_excel(ug.lr, "../lme_results/ug_T1/ug_alpha.xlsx", include_random = FALSE)
save_model_to_excel(ug.f0, "../lme_results/ug_T1/ug_f0.xlsx", include_random = FALSE)
```

```{r RL SI}
save_model_to_excel(rl.rt.neg, "../lme_results/rl_T1/rl_rt_neg.xlsx", include_random = TRUE)
save_model_to_excel(rl.rt.mix, "../lme_results/rl_T1/rl_rt_mix.xlsx", include_random = TRUE)
save_model_to_excel(rl.rt.pos, "../lme_results/rl_T1/rl_rt_pos.xlsx", include_random = TRUE)

save_model_to_excel(rl.opt.neg, "../lme_results/rl_T1/rl_opt_neg.xlsx", include_random = TRUE)
save_model_to_excel(rl.opt.mix, "../lme_results/rl_T1/rl_opt_mix.xlsx", include_random = TRUE)
save_model_to_excel(rl.opt.pos, "../lme_results/rl_T1/rl_opt_pos.xlsx", include_random = TRUE)

save_model_to_excel(rl.alphapos, "../lme_results/rl_T1/rl_alpha_pos.xlsx", include_random = FALSE)
save_model_to_excel(rl.alphaneg, "../lme_results/rl_T1/rl_alpha_neg.xlsx", include_random = FALSE)
save_model_to_excel(rl.beta, "../lme_results/rl_T1/rl_beta.xlsx", include_random = FALSE)
```
